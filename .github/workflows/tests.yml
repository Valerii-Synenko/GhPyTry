name: ðŸ§ª Tests & ðŸ“Š Allure Report

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  setup-environment:
    name: ðŸ³ Setup Test Environment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout microservices-demo
        uses: actions/checkout@v4
        with:
          repository: Valerii-Synenko/microservices-demo
          path: microservices-demo

      - name: Start Docker services
        run: |
          cd microservices-demo/deploy/docker-compose
          docker compose up -d
          
          echo "Waiting for services to start..."
          sleep 60

      - name: Verify services are running
        run: |
          docker ps
          
          CONTAINER_COUNT=$(docker ps -q | wc -l)
          if [ "$CONTAINER_COUNT" -gt 0 ]; then
            echo "âœ… $CONTAINER_COUNT containers running"
          else
            echo "âŒ No containers running"
            exit 1
          fi

      - name: Health check
        run: |
          echo "Checking front-end endpoint..."
          
          for i in {1..15}; do
            if curl -f http://localhost:80 2>/dev/null; then
              echo "âœ… Front-end is ready!"
              exit 0
            fi
            echo "Attempt $i: waiting..."
            sleep 2
          done
          
          echo "âš ï¸ Front-end not responding, but continuing..."

      - name: Save Docker state
        run: |
          # Ð—Ð±ÐµÑ€Ñ–Ð³Ð°Ñ”Ð¼Ð¾ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–ÑŽ Ð¿Ñ€Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ– ÑÐµÑ€Ð²Ñ–ÑÐ¸
          docker ps > docker-status.txt
          docker compose -f microservices-demo/deploy/docker-compose/docker-compose.yml ps >> docker-status.txt

      - name: Upload Docker state
        uses: actions/upload-artifact@v4
        with:
          name: docker-state
          path: docker-status.txt
          retention-days: 1

  run-tests:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: setup-environment

    steps:
      - name: Checkout test repository
        uses: actions/checkout@v4

      - name: Checkout microservices-demo
        uses: actions/checkout@v4
        with:
          repository: Valerii-Synenko/microservices-demo
          path: microservices-demo

      - name: Start Docker services (from previous job)
        run: |
          cd microservices-demo/deploy/docker-compose
          docker compose up -d
          sleep 45
          docker ps

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      - name: Run pytest with Allure
        run: |
          poetry run pytest --alluredir=allure-results -v
        continue-on-error: true

      - name: Display test summary
        if: always()
        run: |
          echo "=== Test Results Summary ==="
          if [ -d "allure-results" ]; then
            echo "Results generated successfully"
            ls -la allure-results/
          else
            echo "âš ï¸ No test results found"
          fi

      - name: Stop Docker services
        if: always()
        run: |
          cd microservices-demo/deploy/docker-compose
          docker compose down -v

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results
          retention-days: 1

  generate-report:
    name: ðŸ“Š Generate & Publish Report
    runs-on: ubuntu-latest
    needs: run-tests
    if: always()

    steps:
      - name: Checkout test repository
        uses: actions/checkout@v4

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: allure-results

      - name: Checkout gh-pages for history
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Install Allure CLI
        run: |
          echo "Installing Allure..."
          wget -q https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
          tar -zxf allure-2.25.0.tgz
          sudo mv allure-2.25.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          
          allure --version

      - name: Restore history
        run: |
          if [ -d "gh-pages/history" ]; then
            echo "âœ… History found from previous runs"
            mkdir -p allure-results/history
            cp -r gh-pages/history/* allure-results/history/
            ls -la allure-results/history/
          else
            echo "â„¹ï¸ No history found (first run)"
          fi

      - name: Generate Allure Report
        run: |
          echo "Generating report..."
          allure generate allure-results -o allure-report --clean
          
          echo "=== Report Generated ==="
          ls -la allure-report/
          
          if [ -d "allure-report/history" ]; then
            echo "âœ… History included in report"
            ls -la allure-report/history/
          fi

      - name: Add report metadata
        run: |
          cat > allure-report/README.md << EOF
          # Allure Test Report
          
          **Generated**: $(date)
          **Run**: #${{ github.run_number }}
          **Commit**: ${{ github.sha }}
          **Branch**: ${{ github.ref_name }}
          
          [View in GitHub Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-report
          keep_files: false
          commit_message: "ðŸ“Š Update Allure Report - Run #${{ github.run_number }}"